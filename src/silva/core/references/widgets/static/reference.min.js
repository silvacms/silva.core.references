(function(e,t,n){var r=null,i=function(e){return r!==null?t.when(r):t.ajax({url:e+"/++rest++silva.core.references.lookup"}).done(function(e){r=e})},s={plugins:{},Manager:function(n,r,i){var s=undefined,o=[],u=[],a=[null],f={configuration:t.extend({},{multiple:!0,index:!1,selected:[]},r),onchange:e.deferred.Callbacks()},l=function(e,t){return e.open(t).pipe(function(e){var n=a.length-1,r=n&&a[n]===null&&a[n-1]==t;if(r||a[n]!==t)a[n]=t,r||f.onchange.invoke(f,[t]);return e})},c=function(e,t){return o.push(e),a.push(null),l(e,t).done(function(e){s=e.insert(s),e.actions!==undefined&&(u.push(n.dialog("option","buttons")),n.dialog("option","buttons",e.actions))})};f=t.extend(f,{add:function(t,r){var s;return o.length<2?(s=e.smi.reference.Adder(n,f,i,r),c(s,t)):(s=o[1],s.update(r),l(s,t))},list:function(t){var r;return o.length?(r=o[0],l(r,t)):(r=new e.smi.reference.Listing(n,f,i),c(r,t))},open:function(e){return l(o[o.length-1],e)},back:function(){if(o.length>1){var e=s.prev();s.slideUp().promise(function(){t(this).remove()}),e.slideDown(),s=e,n.dialog("option","buttons",u.pop()),o.pop(),f.open(a.pop())}}});for(var h in e.smi.reference.plugins)e.smi.reference.plugins[h](n,f);return f}};t.extend(e.smi,{reference:s}),t(document).bind("load-smiplugins",function(n,r){var o=function(){var n=t(this).parent(".reference-widget"),o=n.attr("id"),u=[],a=n.find("#"+o+"-value"),f=n.find('input[name="'+a.attr("name")+'"]'),l=a.hasClass("field-multiple");t.each(f,function(){var e=t(this).val();e&&e!=""&&u.push(e)});var c={Cancel:function(){t(this).dialog("close")}};a.hasClass("field-required")||(c.Clear=function(){var e=ReferencedRemoteObject(n);e.clear(),t(this).dialog("close")});var h=n.find("#"+o+"-base").val();return i(h).done(function(i){var p=t(i),d=new s.Manager(p,{multiple:l,selected:u,index:n.find("#"+o+"-show_container_index").val(),iface:n.find("#"+o+"-interface").val()},r);if(l){var v=[];t.each(u,function(e,t){v.push({intid:t})}),p.bind("selected-smireferences",function(e,t){v.push(t)}),p.bind("deselected-smireferences",function(e,t){for(var n=0;n<v.length;n++)if(v[n].intid==t.intid){v.splice(n,1);break}}),c.Done=function(e){t.each(f,function(){t(this).val("")}),n.find("ul.multiple-references").empty(),t.each(v,function(e,t){var r=e==0?"":String(e),i=f[e];i===undefined&&(i=a.clone(),i.attr("id",o+r+"-value"),i.appendTo(a.parent()));var s=ReferencedRemoteObject(n,r);s.render(t)}),f.length>1&&t.each(f,function(){var e=t(this);e.val()==""&&e.remove()}),p.dialog("close")}}else p.bind("selected-smireferences",function(e,t){var r=ReferencedRemoteObject(n);r.render(t),p.dialog("close")});p.bind("dialogclose",function(){p.remove()}),p.dialog({autoOpen:!1,modal:!0,height:500,width:800,zIndex:12e3,buttons:c}),d.list(h),e.ui.ShowDialog(p)}),!1};t.fn.SMIReferenceLookup=function(){return t(this).delegate(".reference-dialog-trigger","click",o),this},t(".form-fields-container").live("loadwidget-smiform",function(e){t(this).delegate(".reference-dialog-trigger","click",o),e.stopPropagation()}),t(document).ready(function(){t(".reference-dialog-trigger").bind("click",o)})})})(infrae,jQuery,jsontemplate);