(function(e,t,n){var r=null,i=function(e){return r!==null?t.when(r):t.ajax({url:e+"/++rest++silva.core.references.lookup"}).done(function(e){r=e})},s={plugins:{},Manager:function(n,r,i){var s=undefined,o=[],u=[],a=[null],f={configuration:t.extend({},{multiple:!0,show_index:!1,selected:[]},r),onchange:e.deferred.Callbacks()},l=function(e,t){return e.open(t).pipe(function(e){var n=a.length-1,r=n&&a[n]===null&&a[n-1]==t;if(r||a[n]!==t)a[n]=t,r||f.onchange.invoke(f,[t]);return e})},c=function(e,t){return o.push(e),a.push(null),l(e,t).done(function(e){s=e.insert(s),e.actions!==undefined&&(u.push(n.dialog("option","buttons")),n.dialog("option","buttons",e.actions))})};f=t.extend(f,{add:function(t,r){var s;return o.length<2?(s=e.smi.reference.Adder(n,f,i,r),c(s,t)):(s=o[1],s.update(r),l(s,t))},list:function(t){var r;return o.length?(r=o[0],l(r,t)):(r=new e.smi.reference.Listing(n,f,i),c(r,t))},open:function(e){return l(o[o.length-1],e)},back:function(){if(o.length>1){var e=s.prev();s.slideUp().promise(function(){t(this).remove()}),e.slideDown(),s=e,n.dialog("option","buttons",u.pop()),o.pop(),f.open(a.pop())}}});for(var h in e.smi.reference.plugins)e.smi.reference.plugins[h](n,f);return f}};t.extend(e.smi,{reference:s});var o=function(){var n=t(this).parent(".reference-widget"),r=n.attr("id"),o=[],u=n.find("#"+r+"-value"),a=n.find('input[name="'+u.attr("name")+'"]'),f=u.hasClass("field-multiple");t.each(a,function(){var e=t(this).val();e&&e!=""&&o.push(e)});var l={Cancel:function(){t(this).dialog("close")}};u.hasClass("field-required")||(l.Clear=function(){var e=ReferencedRemoteObject(n);e.clear(),t(this).dialog("close")});var c=n.find("#"+r+"-base").val();return i(c).done(function(i){var h=t(i),p=new s.Manager(h,{multiple:f,selected:o,show_index:n.find("#"+r+"-show-index").val(),iface:n.find("#"+r+"-interface").val()},smi);if(f){var d=[];t.each(o,function(e,t){d.push({intid:t})}),h.bind("selected-smireferences",function(e,t){d.push(t)}),h.bind("deselected-smireferences",function(e,t){for(var n=0;n<d.length;n++)if(d[n].intid==t.intid){d.splice(n,1);break}}),l.Done=function(e){t.each(a,function(){t(this).val("")}),n.find("ul.multiple-references").empty(),t.each(d,function(e,t){var i=e==0?"":String(e),s=a[e];s===undefined&&(s=u.clone(),s.attr("id",r+i+"-value"),s.appendTo(u.parent()));var o=ReferencedRemoteObject(n,i);o.render(t)}),a.length>1&&t.each(a,function(){var e=t(this);e.val()==""&&e.remove()}),h.dialog("close")}}else h.bind("selected-smireferences",function(e,t){var r=ReferencedRemoteObject(n);r.render(t),h.dialog("close")});h.bind("dialogclose",function(){h.remove()}),h.dialog({autoOpen:!1,modal:!0,height:500,width:800,zIndex:12e3,buttons:l}),p.list(c),e.ui.ShowDialog(h)}),!1};t.fn.SMIReferenceLookup=function(){return t(this).delegate(".reference-dialog-trigger","click",o),this},t(".form-fields-container").live("loadwidget-smiform",function(e){t(this).delegate(".reference-dialog-trigger","click",o),e.stopPropagation()}),t(document).ready(function(){t(".reference-dialog-trigger").bind("click",o)})})(infrae,jQuery,jsontemplate);