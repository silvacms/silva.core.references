var ReferencedRemoteObject=function(e,t){return function(n,r){var i=n.attr("id"),s=n.find("#"+i+"-base").val(),o=n.find("#"+i+"-interface").val(),u=n.find("#"+i+"-show_container_index").val(),a=n.find("ul.multiple-references");r&&(i+=r);var f=n.find("#"+i+"-value"),l=n.find("#"+i+"-link"),c=n.find("#"+i+"-edit-link");if(!l.length){var h=e("<li />");l=e('<a id="'+i+'-link" />'),c=e('<a id="'+i+'-edit-link" />'),h.append(l),h.append(c),a.append(h)}var p={identifier:i+"-value",data:function(){return f.data("referenced-remote-content")},reference:function(){return f.val()},title:function(){var e=p.data();return e?e.title:"no reference selected"},url:function(){var e=p.data();return e?e.url:""},clear:function(e){e||(e="no reference selected"),c.hide(),c.attr("href","#"),l.text(e),l.bind("click",function(){return!1}),l.attr("href","#"),l.removeAttr("title"),f.length&&(f.val("0"),f.trigger("remote-reference-modified",{}))},fetch:function(t){var n={intid:t};l.text("loading ..."),f.length&&f.val(t),o&&(n["interface"]=o),u&&(n.show_container_index="true"),e.getJSON(s+"/++rest++silva.core.references.items",n,p.render)},render:function(n){var r=e('<ins class="icon" />'),i=function(e,t){t?l.attr(e,t):l.removeAttr(e)};l.empty(),l.text(n.title),i("href",n.url),i("title",n.path),l.unbind("click"),n.url&&(c.show(),c.attr("href",n.path)),l.data("content",n),t.ui.icon(r,n.icon),r.prependTo(l),f.length&&(f.val(n.intid),f.trigger("reference-modified",n))},change:function(e){f.bind("reference-modified",e)},show:n.show,hide:n.hide,toggle:n.toggle};return p}}(jQuery,infrae);(function(e,t,n){function s(e,t){for(var n=0;n<e.length;n++)if(e[n]["id"]==t)return n;return null}var r={plugins:{}};r.plugins.AddMenu=function(e,n){var r=e.find(".content-actions"),i=r.find("a"),s=r.find("select"),o=s.html(),u=null,a=function(){var e=s.val();return e&&u&&n.add(u,e),!1};i.bind("click",a),s.bind("change",a),n.onchange.add(function(e){var i={url:e+"/++rest++silva.core.references.addables",dataType:"json"};n.configuration.iface!==undefined&&(i.data={"interface":n.configuration.iface}),t.ajax(i).done(function(t){var n=[o];r.toggle(t.length!==0);for(var i=0,a=t.length;i<a;i++)n.push('<option value="'+t[i]+'">'+t[i]+"</option>");u=e,s.html(n.join(""))})})},r.plugins.Breadcrumbs=function(){var e=new n.Template('<span class="path-outer"><span class="path-inner">{.section link}<a href="{url|html-attr-value}" title="{id|html-attr-value}">{short_title|html}</a>{.end}{.section last}<span class="last">{short_title|html}</span>{.end}</span>{.section separator}<span class="separator">&rsaquo;</span>{.end}</span>'),r=3;return function(n,i){var s=n.find(".path-list");s.delegate("a","click",function(e){return i.open(t(e.target).attr("href")),!1}),i.onchange.add(function(n){t.ajax({url:n+"/++rest++silva.core.references.parents",dataType:"json"}).done(function(t){var n=t.length,i=1,o=[],u=function(t,n){return e.expand({separator:!n,last:n&&t,link:!n&&t})};o.push(u(t[0],1==n)),r!=0&&n>r+1&&(i=n-r,o.push('<span class="path-outer"><span class="path-inner"><span class="path-fake">...</span></span><span class="separator">&rsaquo;</span></span>'));for(;i<n;i++)o.push(u(t[i],i+1==n));s.html(o.join(""))})})}}(),r.Manager=function(){var n={multiple:!0,selected:[]};return function(s,u,a){var f=undefined,l=[],c=[],h=[null],p={configuration:t.extend({},n,u),onchange:e.deferred.Callbacks(),get_selection:function(){return l.length?l[0].selection:undefined}},d=function(e,t){return e.open(t).pipe(function(e){var n=h.length-1,r=n&&h[n]===null&&h[n-1]==t;if(r||h[n]!==t)h[n]=t,r||p.onchange.invoke(p,[t]);return e})},v=function(e,t){return l.push(e),h.push(null),d(e,t).done(function(e){if(f!==undefined){var t=e.$content;t!==undefined&&t!==f&&(t.hide(),t.insertAfter(f),f.slideUp(),t.slideDown(),f=t)}else f=e.$content;e.actions!==undefined&&(c.push(s.dialog("option","buttons")),s.dialog("option","buttons",e.actions))})};p=t.extend(p,{add:function(e,t){var n;return l.length<2?(n=i(s,p,a,t),v(n,e)):(n=l[1],n.update(t),d(n,e))},list:function(e){var t;return l.length?(t=l[0],d(t,e)):(t=new o(s,p,a),v(t,e))},open:function(e){return d(l[l.length-1],e)},back:function(){if(l.length>1){var e=f.prev();f.slideUp().promise(function(){t(this).remove()}),e.slideDown(),f=e,s.dialog("option","buttons",c.pop()),l.pop(),p.open(h.pop())}}});for(var m in r.plugins)r.plugins[m](s,p);return p}}();var i=function(n,r,i,s){var o=t('<div class="content-list" />'),u=null,a=null,f=null;return{open:function(t){a=t+"/++rest++silva.core.references.adding/"+s;var n=function(t){return o.html(t.screen.forms),u=o.children("form"),u.attr("data-form-url",a),u.trigger("load-smiform",{form:u,container:u}),f!==null?(u.bind("submit",f),{}):(f=function(){var t=u.serializeArray();return t.push({name:u.attr("name")+".action.save",value:"Save"}),i.ajax.query(a,t).pipe(function(t){e.interfaces.is_implemented_by("redirect",t)?r.back():n(t)}),!1},u.bind("submit",f),{$content:o,actions:{Back:r.back,Add:f}})};return i.ajax.query(a).pipe(n)},update:function(e){s=e}}};Function.prototype.scope===undefined&&(Function.prototype.scope=function(e){var t=this;return function(){return t.apply(e,arguments)}});var o=function(e,n,r){this.element=e,this.referenceInterface=n.configuration.iface,this.showContainerIndex=n.configuration.show_container_index,this.parent=null,this.current=null,this.selection=[],this.selectionIndex={};var i=t([]);this.listElement=t("table.source-list tbody",this.element),i=i.add(this.listElement),this.selectionElement=null,this.options=n.configuration;if(this.options.multiple===!0){var s=t("div.selection-list",this.element);this.selectionElement=s.find("tbody"),i=i.add(this.selectionElement);var o=new u(this.selectionElement,this);o.render(),this.options.selected.length>0&&t.each(this.options.selected,function(e,n){var r="++rest++silva.core.references.items";t.getJSON(r,{intid:n},function(e){var t=new a(this,e);this.selectItem(t)}.scope(this))}.scope(this)),s.show()}i.delegate("a.preview-icon","click",!1),i.delegate("tr.folderish","mouseenter",function(e){t(this).addClass("folderish-hover")}),i.delegate("tr.folderish","mouseleave",function(e){t(this).removeClass("folderish-hover")}),i.delegate("tr.folderish","click",function(e){return n.open(t(this).data("smilisting").url),!1})};o.prototype.open=function(e){var n={url:e+"/++rest++silva.core.references.items"};return n.data={},this.referenceInterface&&(n.data["interface"]=this.referenceInterface),this.showContainerIndex&&(n.data.show_container_index="true"),this.listElement.empty(),t.ajax(n).pipe(function(e){this.listElement.empty(),this.current=e[s(e,".")];var t=s(e,"..");return t!=null?this.parent=e.splice(t,1)[0]:this.parent=null,this.render(e),{$content:this.element.find(".content-list")}}.scope(this))},o.prototype.render=function(e){t.each(e,function(e,n){var r=new a(this,n),i=t('<tr class="item" />');i.attr("id",this.itemDomId(r)),i.data("smilisting",n);var s=new f(i,r);s.render(),this.isSelected(r)&&s.disableSelectButton(),this.listElement.append(i)}.scope(this))},o.prototype.itemDomId=function(e){return"list-selection"+e.info.intid},o.prototype._itemClicked=function(e,t){this.isSelected(t)?this.deselectItem(t):this.selectItem(t)},o.prototype._itemRemovedFromSelection=function(e,t){this.deselectItem(t)},o.prototype.selectItem=function(e){this.element.trigger("selected-smireferences",[e]);if(this.options.multiple){var n=e.info.intid;this.select(e);var r=new u(this.selectionElement,this);r.appendSelectionItem(e);var i=new f(t("#"+this.itemDomId(e)),e);i.disableSelectButton()}},o.prototype.select=function(e){this.selection.push(e),this.selectionIndex[e.info.intid]=this.selection.length-1},o.prototype.deselectItem=function(e){var n=e.info.intid,r=this.selectionIndex[n];this.selection.splice(r,1),delete this.selectionIndex[n],this.element.trigger("deselected-smireferences",[e]);var i=new u(this.selectionElement,this);i.removeSelectionItem(e);var s=new f(t("#"+this.itemDomId(e)),e);s.enableSelectButton()},o.prototype.isSelected=function(e){var t=e.info.intid,n=this.selectionIndex[t];return n>=0?!0:!1};var u=function(e,n){this.element=t(e),this.contentList=n};u.prototype.appendSelectionItem=function(e){var n=t("<tr />"),r=new l(n,e);r.render(),n.attr("id",this.itemDomId(e)),this.element.append(n)},u.prototype.removeSelectionItem=function(e){t("#"+this.itemDomId(e)).remove()},u.prototype.render=function(e){this.element.empty();for(var t=0;t<this.contentList.selection.length;t++)this.appendSelectionItem(this.contentList.selection[t])},u.prototype.itemDomId=function(e){return"selection-item-"+e.info.intid};var a=function(e,t){this.contentList=e,this.info=t},f=function(e,n){this.item=n,this.element=t(e)};f.prototype.disableSelectButton=function(){this.getSelectButton().hide()},f.prototype.enableSelectButton=function(){this.getSelectButton().show()},f.prototype.getSelectButton=function(){return this.element.find("td.cell_actions .reference_add")},f.prototype.render=function(){var n=this.item.info["id"]==".",r=t('<td><a class="preview-icon"><ins class="icon"></ins></a></td>'),i=t("<td />"),s=t('<td class="element-id" />'),o=t("<td />");n?(this.element.addClass("current"),s.text("current location")):(this.item.info.folderish&&this.element.addClass("folderish"),s.text(this.item.info.id)),o.text(this.item.info.title),e.ui.icon(r.find("ins"),this.item.info.icon);if(this.item.info["implements"]){var u=t('<img class="button reference_add"src="++static++/silva.core.references.widgets/add.png" />');u.click(function(e){return this.item.contentList._itemClicked(e,this.item),e.stopPropagation(),!1}.scope(this)),i.append(u)}r.appendTo(this.element),s.appendTo(this.element),o.appendTo(this.element),i.appendTo(this.element)};var l=function(e,n){this.item=n,this.element=t(e)};l.prototype.render=function(){var n=t('<td><a class="preview-icon"><ins class="icon"></ins></a></td>'),r=t("<td />"),i=t("<td />"),s=t("<td />"),o=t('<img class="button reference_remove"src="++static++/silva.core.references.widgets/delete.png" />');o.click(function(e){return this.item.contentList._itemRemovedFromSelection(e,this.item),!1}.scope(this)),r.append(o),i.text(this.item.info.path),s.text(this.item.info.title),e.ui.icon(n.find("ins"),this.item.info.icon),n.appendTo(this.element),i.appendTo(this.element),s.appendTo(this.element),r.appendTo(this.element)};var c=null,h=function(e){return c!==null?t.when(c):t.ajax({url:e+"/++rest++silva.core.references.lookup"}).done(function(e){c=e})};t(document).bind("load-smiplugins",function(n,i){var s=function(){var n=t(this).parent(".reference-widget"),s=n.attr("id"),o=[],u=n.find("#"+s+"-value"),a=n.find('input[name="'+u.attr("name")+'"]'),f=u.hasClass("field-multiple");t.each(a,function(){var e=t(this).val();e&&e!=""&&o.push(e)});var l={Cancel:function(){t(this).dialog("close")}};u.hasClass("field-required")||(l.Clear=function(){var e=ReferencedRemoteObject(n);e.clear(),t(this).dialog("close")});var c=n.find("#"+s+"-base").val();return h(c).done(function(h){var p=t(h),d=new r.Manager(p,{multiple:f,selected:o,show_container_index:n.find("#"+s+"-show_container_index").val(),iface:n.find("#"+s+"-interface").val()},i);f?l.Done=function(e){t.each(a,function(){t(this).val("")}),n.find("ul.multiple-references").empty(),t.each(d.get_selection(),function(e,t){var r=e==0?"":String(e),i=a[e];i===undefined&&(i=u.clone(),i.attr("id",s+r+"-value"),i.appendTo(u.parent()));var o=ReferencedRemoteObject(n,r);o.render(t.info)}),a.length>1&&t.each(a,function(){var e=t(this);e.val()==""&&e.remove()}),p.dialog("close")}:p.bind("selected-smireferences",function(e,t){var r=ReferencedRemoteObject(n);r.render(t.info),p.dialog("close")}),p.bind("dialogclose",function(){p.remove()}),p.dialog({autoOpen:!1,modal:!0,height:500,width:800,zIndex:12e3,buttons:l}),d.list(c),e.ui.ShowDialog(p)}),!1};t.fn.SMIReferenceLookup=function(){return t(this).delegate(".reference-dialog-trigger","click",s),this},t(".form-fields-container").live("loadwidget-smiform",function(e){t(this).delegate(".reference-dialog-trigger","click",s),e.stopPropagation()}),t(document).ready(function(){t(".reference-dialog-trigger").bind("click",s)})})})(infrae,jQuery,jsontemplate);