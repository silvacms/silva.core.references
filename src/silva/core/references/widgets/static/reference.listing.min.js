(function(e,t,n){var r=e.deferred.LazyCallbacks(),i=function(e,n,r){var i=t([]),o=this;this.$list=e.find(".content-list"),this.$elements=this.$list.find("table.source-list tbody"),this.options=n.configuration,this.selected=[].concat(this.options.selected),i=i.add(this.$elements);if(this.options.multiple===!0){var a=new u(e,n,r);i=i.add(a.$element),e.bind("deselected-smireferences",function(e,t){var n=new s(t,!0);n.find(),n.enable()}),e.bind("selected-smireferences",function(e,t){var n=new s(t,!1);n.find(),n.disable(),o.selected.push(t.intid)})}i.delegate("tr.folderish","mouseenter",function(e){t(this).addClass("folderish-hover")}),i.delegate("tr.folderish","mouseleave",function(e){t(this).removeClass("folderish-hover")}),this.$elements.delegate("tr.folderish","click",function(e){return n.open(t(this).data("smilisting").url),!1}),this.$elements.delegate("img.reference-add","click",function(e){var n=t(this).closest("tr.item");return n.trigger("selected-smireferences",[n.data("smilisting")]),e.stopPropagation(),!1})};i.prototype.open=function(e){var n=this,r={url:e+"/++rest++silva.core.references.items",data:{}};return n.options.iface&&(r.data["interface"]=n.options.iface),n.options.index&&(r.data.show_container_index="true"),n.$elements.empty(),t.ajax(r).pipe(function(e){return n.render(e),{$content:n.$list,insert:function(e){return this.$content}}})},i.prototype.render=function(e){var t=this;r.reset(),t.$elements.empty(),r.add(e,function(e){var n=new s(e,t.used(e));t.$elements.append(n.render())})},i.prototype.used=function(e){return t.inArray(e.intid,this.selected)>-1};var s=function(e,n){this.item=e,this.id=e.id,this.$item=t([]),e.id=="."&&(this.id="current container"),this.htmlid="content-item-"+e.intid,this.selectable=this.item["implements"]&&n!==!0};s.prototype.find=function(){this.$item=t("#"+this.htmlid)},s.prototype.disable=function(){this.$item.length&&this.selectable&&(this.$item.find("td.actions").empty(),this.selectable=!1)},s.prototype.enable=function(){this.$item.length&&!this.selectable&&(this.$item.find("td.actions").html('<img class="button reference-add" src="++static++/silva.core.references.widgets/add.png" />'),this.selectable=!0)};var o=new n.Template('<tr class="item" id="{htmlid|html-attr-value}"><td><a class="preview-icon"><ins class="icon"></ins></a></td><td class="item-id">{id|html}</td><td class="item-title">{item.title|html}</td><td class="actions">{.section selectable}<img class="button reference-add" src="++static++/silva.core.references.widgets/add.png" />{.end}</td></tr>');s.prototype.render=function(){var n=t(o.expand(this));return this.item.id=="."?n.addClass("top"):this.item.folderish&&n.addClass("folderish"),e.ui.icon(n.find("ins.icon"),this.item.icon),n.data("smilisting",this.item),this.$item=n,n};var u=function(e,n,r){this.$list=e.find("table.selection-list"),this.$elements=this.$list.find("tbody"),this.options=n.configuration;var i=this;this.options.selected.length>0&&t.each(this.options.selected,function(e,n){var r="++rest++silva.core.references.items";t.getJSON(r,{intid:n},function(e){i.add(e)})}),this.$elements.delegate("img.reference-remove","click",function(e){var n=t(this).closest("tr.item");return n.trigger("deselected-smireferences",[n.data("smilisting")]),e.stopPropagation(),!1}),e.bind("deselected-smireferences",function(e,t){var n=new a(t);n.find(),n.remove()}),e.bind("selected-smireferences",function(e,t){i.add(t)}),this.$list.show()};u.prototype.add=function(e){var t=new a(e);this.$elements.append(t.render())};var a=function(e){this.item=e,this.htmlid="selection-item-"+e.intid,this.$item=undefined};a.prototype.find=function(e){this.$item=t("#"+this.htmlid)},a.prototype.remove=function(){this.$item!==undefined&&this.$item.remove()};var f=new n.Template('<tr class="item" id="{htmlid|html-attr-value}"><td><a class="preview-icon"><ins class="icon"></ins></a></td><td class="item-id">{item.path|html}</td><td class="item-title">{item.title|html}</td><td class="actions"><img class="button reference-remove" src="++static++/silva.core.references.widgets/delete.png" /></td></tr>');a.prototype.render=function(){var n=t(f.expand(this));return e.ui.icon(n.find("ins.icon"),this.item.icon),n.data("smilisting",this.item),this.$item=n,n},t.extend(e.smi.reference,{Listing:i})})(infrae,jQuery,jsontemplate);