(function(infrae,$,jsontemplate){var worker=infrae.deferred.LazyCallbacks(),ContentList=function($popup,manager,smi){var listings=$([]),self=this;this.$list=$popup.find(".content-list"),this.$elements=this.$list.find("table.source-list tbody"),this.options=manager.configuration,this.selected=[];for(var i=0,len=this.options.selected.length;len>i;i++)this.selected.push(+this.options.selected[i]);if(listings=listings.add(this.$elements),this.options.multiple===!0){var selection=new SelectionList($popup,manager,smi);listings=listings.add(selection.$element),$popup.bind("deselected-smireferences",function(event,item){var view=new ContentListItemView(item,!0),index=$.inArray(item.intid,self.selected);view.find(),view.unselect(),index>-1&&self.selected.splice(index,1)}),$popup.bind("selected-smireferences",function(event,item){var view=new ContentListItemView(item,!1);view.find(),view.select(),self.selected.push(item.intid)})}listings.delegate("tr.folderish","mouseenter",function(){$(this).addClass("folderish-hover")}),listings.delegate("tr.folderish","mouseleave",function(){$(this).removeClass("folderish-hover")}),this.$elements.delegate("tr.folderish","click",function(){return manager.open($(this).data("smilisting").url),!1}),this.$elements.delegate("img.reference-add","click",function(event){var $item=$(this).closest("tr.item");return $item.trigger("selected-smireferences",[$item.data("smilisting")]),event.stopPropagation(),!1})};ContentList.prototype.open=function(url){var self=this,options={url:url+"/++rest++silva.core.references.items",data:{}};return self.options.iface&&(options.data["interface"]=self.options.iface),self.options.show_index&&(options.data.show_index="true"),self.$elements.empty(),$.ajax(options).then(function(data){return self.render(data),{$content:self.$list,insert:function(){return this.$content}}})},ContentList.prototype.render=function(items){var self=this;worker.reset(),self.$elements.empty(),worker.add(items,function(item){var view=new ContentListItemView(item,self.used(item));self.$elements.append(view.render())})},ContentList.prototype.used=function(item){return $.inArray(item.intid,this.selected)>-1};var ContentListItemView=function(item,selected){this.item=item,this.$item=$([]),this.id=item.id,"."==item.id&&(this.id="current container"),this.htmlid="content-item-"+item.intid,this.selected=selected,this.selectable=this.item["implements"]&&selected!==!0};ContentListItemView.prototype.find=function(){this.$item=$("#"+this.htmlid)},ContentListItemView.prototype.select=function(){this.$item.length&&this.selectable&&(this.$item.find("td.actions").empty(),this.$item.addClass("selected"),this.selectable=!1,this.selected=!1)},ContentListItemView.prototype.unselect=function(){this.$item.length&&!this.selectable&&(this.$item.find("td.actions").html('<img class="button reference-add" src="++static++/silva.core.references.widgets/add.png" />'),this.$item.removeClass("selected"),this.selectable=!0,this.selected=!0)};var ContentListItemTemplate=new jsontemplate.Template('<tr class="{classes|html-attr-value}" id="{htmlid|html-attr-value}"><td><a class="preview-icon"><ins class="icon"></ins></a></td><td class="item-id">{id|html}</td><td class="item-title">{item.title|html}</td><td class="actions">{.section selectable}<img class="button reference-add" src="++static++/silva.core.references.widgets/add.png" />{.end}</td></tr>');ContentListItemView.prototype.render=function(){var $item,classes=["item"];return"."==this.item.id?classes.push("top"):this.item.folderish&&classes.push("folderish"),this.selected&&classes.push("selected"),this.classes=classes.join(" "),$item=$(ContentListItemTemplate.expand(this)),$item.data("smilisting",this.item),infrae.ui.icon($item.find("ins.icon"),this.item.icon),this.$item=$item,$item};var SelectionList=function($popup,manager){this.$list=$popup.find("table.selection-list"),this.$elements=this.$list.find("tbody"),this.options=manager.configuration;var self=this;this.options.selected.length>0&&$.each(this.options.selected,function(index,identifier){var url="++rest++silva.core.references.items";$.getJSON(url,{intid:identifier},function(entry){self.add(entry)})}),this.$elements.delegate("img.reference-remove","click",function(event){var $item=$(this).closest("tr.item");return $item.trigger("deselected-smireferences",[$item.data("smilisting")]),event.stopPropagation(),!1}),$popup.bind("deselected-smireferences",function(event,item){var view=new SelectionListItemView(item);view.find(),view.remove()}),$popup.bind("selected-smireferences",function(event,item){self.add(item)}),this.$list.show()};SelectionList.prototype.add=function(item){var view=new SelectionListItemView(item);this.$elements.append(view.render())};var SelectionListItemView=function(item){this.item=item,this.htmlid="selection-item-"+item.intid,this.$item=void 0};SelectionListItemView.prototype.find=function(){this.$item=$("#"+this.htmlid)},SelectionListItemView.prototype.remove=function(){void 0!==this.$item&&this.$item.remove()};var SelectionListItemTemplate=new jsontemplate.Template('<tr class="item" id="{htmlid|html-attr-value}"><td><a class="preview-icon"><ins class="icon"></ins></a></td><td class="item-id">{item.path|html}</td><td class="item-title">{item.title|html}</td><td class="actions"><img class="button reference-remove" src="++static++/silva.core.references.widgets/delete.png" /></td></tr>');SelectionListItemView.prototype.render=function(){var $item=$(SelectionListItemTemplate.expand(this));return infrae.ui.icon($item.find("ins.icon"),this.item.icon),$item.data("smilisting",this.item),this.$item=$item,$item},$.extend(infrae.smi.reference,{Listing:ContentList})})(infrae,jQuery,jsontemplate);