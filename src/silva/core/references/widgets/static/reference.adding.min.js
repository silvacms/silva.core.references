(function(infrae,$){$.extend(infrae.smi.reference,{Adder:function($popup,manager,smi,addable){var $content=$('<div class="content-list" />'),$form=null,form_url=null,action=null;return{open:function(url){form_url=url+"/++rest++silva.core.references.adding/"+addable;var render=function(data){return $content.html(data.screen.forms),$form=$content.children("form"),$form.attr("data-form-url",form_url),null!==action?($form.bind("submit",action),$form.trigger("load-smiform",{form:$form,container:$form}),{}):(action=function(){var values=$form.serializeArray();return values.push({name:$form.attr("name")+".action.save",value:"Save"}),smi.ajax.query(form_url,values).then(function(data){infrae.interfaces.is_implemented_by("redirect",data)?manager.back():render(data)}),!1},$form.bind("submit",action),{insert:function($current){return $content!==$current&&($content.hide(),$content.insertAfter($current),$current.slideUp(),$content.slideDown()),$form.trigger("load-smiform",{form:$form,container:$form}),$content},$content:$content,actions:{Back:manager.back,Add:action}})};return smi.ajax.query(form_url).then(render)},update:function(new_addable){addable=new_addable}}}})})(infrae,jQuery,jsontemplate);